<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Minas Bahia - PMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-blue-600">Hotel Minas Bahia</h1>
                </div>
                <div class="flex space-x-4">
                    <a href="quartos.html" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md">
                        <i class="fas fa-bed mr-2"></i>Quartos
                    </a>
                    <a href="reservas.html" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md">
                        <i class="fas fa-calendar-alt mr-2"></i>Reservas
                    </a>
                    <a href="cadastros.html" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md">
                        <i class="fas fa-users mr-2"></i>Cadastros
                    </a>
                    <a href="caixa.html" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md">
                        <i class="fas fa-cash-register mr-2"></i>Caixa
                    </a>
                    <a href="admin.html" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md">
                        <i class="fas fa-cog mr-2"></i>Admin
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Resumo -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Ocupação</h2>
                <div class="text-3xl font-bold text-blue-600" id="taxaOcupacao">--</div>
                <p class="text-gray-600" id="resumoOcupacao">-- de -- quartos ocupados</p>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Disponíveis</h2>
                <div class="text-3xl font-bold text-green-600" id="quartosDisponiveis">--</div>
                <p class="text-gray-600">Quartos livres</p>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Ocupados</h2>
                <div class="text-3xl font-bold text-red-600" id="quartosOcupados">--</div>
                <p class="text-gray-600">Quartos ocupados</p>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Limpeza</h2>
                <div class="text-3xl font-bold text-yellow-600" id="quartosSujos">--</div>
                <p class="text-gray-600">Aguardando limpeza</p>
            </div>
        </div>

        <!-- Mapa de Quartos -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Mapa de Quartos</h2>
                <div class="flex gap-4">
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded-full bg-green-500 mr-2"></div>
                        <span>Disponível</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded-full bg-red-500 mr-2"></div>
                        <span>Ocupado</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded-full bg-yellow-500 mr-2"></div>
                        <span>Sujo</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 rounded-full bg-gray-500 mr-2"></div>
                        <span>Manutenção</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="mapaQuartos">
                <!-- Quartos serão inseridos aqui via JavaScript -->
            </div>
        </div>
    </main>

    <!-- Modal de Ações Rápidas -->
    <div id="acaoRapidaModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-xl font-bold mb-4">Quarto <span id="quartoNumero"></span></h3>
            <div class="space-y-3">
                <button onclick="realizarCheckin()" class="w-full bg-green-600 text-white px-4 py-2 rounded-md">
                    <i class="fas fa-sign-in-alt mr-2"></i>Check-in
                </button>
                <button onclick="realizarCheckout()" class="w-full bg-red-600 text-white px-4 py-2 rounded-md">
                    <i class="fas fa-sign-out-alt mr-2"></i>Check-out
                </button>
                <button onclick="marcarLimpeza()" class="w-full bg-yellow-600 text-white px-4 py-2 rounded-md">
                    <i class="fas fa-broom mr-2"></i>Marcar para Limpeza
                </button>
                <button onclick="fecharModal()" class="w-full bg-gray-300 text-gray-700 px-4 py-2 rounded-md">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Ações do Quarto -->
    <div id="modalQuarto" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-10 mx-auto p-5 border max-w-4xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold" id="modalTituloQuarto">Quarto 101</h3>
                <button onclick="fecharModal()" class="text-gray-600 hover:text-gray-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Informações do Quarto -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <div class="grid grid-cols-3 gap-4 text-sm">
                    <div>
                        <span class="font-semibold">Tipo:</span>
                        <span id="modalTipoQuarto"></span>
                    </div>
                    <div>
                        <span class="font-semibold">Capacidade:</span>
                        <span id="modalCapacidadeQuarto"></span> pessoas
                    </div>
                    <div>
                        <span class="font-semibold">Valor por pessoa:</span>
                        R$ <span id="modalValorQuarto"></span>
                    </div>
                </div>
            </div>

            <!-- Formulário de Check-in (visível apenas se quarto disponível) -->
            <div id="formCheckIn" class="hidden">
                <form id="checkInForm" onsubmit="realizarCheckIn(event)" class="space-y-6">
                    <input type="hidden" id="quartoId">
                    
                    <!-- Titular da Hospedagem -->
                    <div class="border-b pb-4">
                        <h4 class="text-lg font-semibold mb-4">Titular da Hospedagem</h4>
                        <div class="flex gap-4 items-end">
                            <div class="flex-grow">
                                <label class="block text-sm font-medium text-gray-700">Selecionar Cadastro</label>
                                <select id="titularSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                                        onchange="selecionarTitular(this.value)">
                                    <option value="">Selecione um cadastro...</option>
                                </select>
                            </div>
                            <button type="button" onclick="abrirModalCadastroRapido('titular')"
                                    class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                Novo Cadastro
                            </button>
                        </div>
                        <!-- Informações do titular selecionado -->
                        <div id="infoTitular" class="mt-4 hidden">
                            <!-- Preenchido via JavaScript -->
                        </div>
                    </div>

                    <!-- Acompanhantes -->
                    <div class="border-b pb-4">
                        <h4 class="text-lg font-semibold mb-4">Acompanhantes</h4>
                        <div id="listaAcompanhantes" class="space-y-4">
                            <!-- Lista de acompanhantes adicionados -->
                        </div>
                        <button type="button" onclick="adicionarAcompanhante()"
                                class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>Adicionar Acompanhante
                        </button>
                    </div>

                    <!-- Valores e Datas -->
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-semibold mb-4">Datas</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Check-in</label>
                                    <input type="datetime-local" id="dataCheckIn" required
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Check-out Previsto</label>
                                    <input type="datetime-local" id="dataCheckOutPrevisto" required
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                                           onchange="calcularValorTotal()">
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold mb-4">Valores</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Valor Base</label>
                                    <input type="text" id="valorBase" readonly
                                           class="mt-1 block w-full rounded-md bg-gray-50 border-gray-300 shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Desconto</label>
                                    <input type="number" id="desconto" min="0" step="0.01"
                                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                                           onchange="calcularValorTotal()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Valor Total</label>
                                    <input type="text" id="valorTotal" readonly
                                           class="mt-1 block w-full rounded-md bg-gray-50 border-gray-300 shadow-sm font-bold text-lg">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botões -->
                    <div class="flex justify-end space-x-2 pt-4">
                        <button type="button" onclick="fecharModal()"
                                class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                            Cancelar
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Confirmar Check-in
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Cadastro Rápido -->
    <div id="modalCadastroRapido" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <!-- Conteúdo do modal -->
    </div>

    <script>
        let quartosData = [];

        // Variáveis globais para check-in
        let quartoSelecionado = null;
        let acompanhantes = [];
        let valorPorPessoa = 0;

        async function carregarQuartos() {
            try {
                const response = await fetch('./api/quartos.php');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                quartosData = await response.json();
                atualizarMapaQuartos();
                atualizarResumo();
            } catch (error) {
                console.error('Erro ao carregar quartos:', error);
            }
        }

        function atualizarMapaQuartos() {
            const container = document.getElementById('mapaQuartos');
            container.innerHTML = quartosData.map(quarto => `
                <div class="bg-white p-4 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow"
                     onclick="mostrarModalQuarto(${quarto.id})">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold">${quarto.numero}</h3>
                        <span class="w-3 h-3 rounded-full ${getStatusColor(quarto.status)}"></span>
                    </div>
                    <p class="text-gray-600 text-sm mb-2">${quarto.tipo}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500 text-sm">
                            R$ ${quarto.preco_diaria}
                        </span>
                        <span class="text-sm ${getStatusTextColor(quarto.status)}">
                            ${getStatusText(quarto.status)}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function getStatusColor(status) {
            const cores = {
                'disponivel': 'bg-green-500',
                'ocupado': 'bg-red-500',
                'sujo': 'bg-yellow-500',
                'manutencao': 'bg-gray-500'
            };
            return cores[status] || 'bg-gray-500';
        }

        function getStatusTextColor(status) {
            const cores = {
                'disponivel': 'text-green-600',
                'ocupado': 'text-red-600',
                'sujo': 'text-yellow-600',
                'manutencao': 'text-gray-600'
            };
            return cores[status] || 'text-gray-600';
        }

        function getStatusText(status) {
            const textos = {
                'disponivel': 'Disponível',
                'ocupado': 'Ocupado',
                'sujo': 'Sujo',
                'manutencao': 'Manutenção'
            };
            return textos[status] || status;
        }

        function atualizarResumo() {
            const total = quartosData.length;
            const ocupados = quartosData.filter(q => q.status === 'ocupado').length;
            const disponiveis = quartosData.filter(q => q.status === 'disponivel').length;
            const sujos = quartosData.filter(q => q.status === 'sujo').length;
            
            document.getElementById('taxaOcupacao').textContent = `${Math.round((ocupados/total) * 100)}%`;
            document.getElementById('resumoOcupacao').textContent = `${ocupados} de ${total} quartos ocupados`;
            document.getElementById('quartosDisponiveis').textContent = disponiveis;
            document.getElementById('quartosOcupados').textContent = ocupados;
            document.getElementById('quartosSujos').textContent = sujos;
        }

        function mostrarAcoesRapidas(quartoId) {
            const quarto = quartosData.find(q => q.id === quartoId);
            document.getElementById('quartoNumero').textContent = quarto.numero;
            document.getElementById('acaoRapidaModal').classList.remove('hidden');
        }

        function fecharModal() {
            document.getElementById('acaoRapidaModal').classList.add('hidden');
        }

        // Atualizar status do quarto
        async function atualizarStatusQuarto(quartoId, novoStatus) {
            try {
                const formData = new FormData();
                formData.append('id', quartoId);
                formData.append('status', novoStatus);
                formData.append('action', 'update_status');

                const response = await fetch('./api/quartos.php', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                await carregarQuartos();
                fecharModal();
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                alert('Erro ao atualizar status do quarto. Tente novamente.');
            }
        }

        // Carregar quartos ao iniciar a página
        carregarQuartos();

        // Atualizar a cada 30 segundos
        setInterval(carregarQuartos, 30000);

        // Funções para gerenciar o modal de quarto
        async function mostrarModalQuarto(quartoId) {
            const quarto = quartosData.find(q => q.id === quartoId);
            if (!quarto) return;

            switch(quarto.status) {
                case 'disponivel':
                    mostrarModalCheckIn(quarto);
                    break;
                case 'ocupado':
                    mostrarModalHospedagemAtiva(quarto);
                    break;
                case 'sujo':
                    mostrarModalQuartoSujo(quarto);
                    break;
                default:
                    alert('Status do quarto não reconhecido');
            }
        }

        // Função para mostrar modal de hospedagem ativa
        async function mostrarModalHospedagemAtiva(quarto) {
            try {
                const response = await fetch(`./api/checkin.php?quarto_id=${quarto.id}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.message);
                }

                if (!data) {
                    throw new Error('Não foi encontrada hospedagem ativa');
                }

                const modalContent = `
                    <div class="relative top-20 mx-auto p-5 border max-w-2xl shadow-lg rounded-md bg-white">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-bold">Quarto ${quarto.numero} - Hospedagem Ativa</h3>
                            <button onclick="fecharModal()" class="text-gray-600 hover:text-gray-800">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="space-y-6">
                            <!-- Informações da Hospedagem -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">Informações da Hospedagem</h4>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <p class="text-gray-600">Check-in:</p>
                                        <p class="font-medium">${formatarDataHora(data.data_checkin)}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600">Check-out Previsto:</p>
                                        <p class="font-medium">${formatarDataHora(data.data_checkout_previsto)}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600">Valor Total:</p>
                                        <p class="font-medium">R$ ${parseFloat(data.valor_total).toFixed(2)}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600">Desconto Aplicado:</p>
                                        <p class="font-medium">R$ ${parseFloat(data.desconto).toFixed(2)}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Informações do Titular -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2">Titular</h4>
                                <p class="font-medium">${data.titular_nome}</p>
                                <p class="text-sm text-gray-600">CPF: ${data.titular_cpf}</p>
                            </div>

                            ${data.acompanhantes.length ? `
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-semibold mb-2">Acompanhantes</h4>
                                    <ul class="space-y-2">
                                        ${data.acompanhantes.map(acomp => `
                                            <li class="text-sm">
                                                <span class="font-medium">${acomp.nome}</span>
                                                <span class="text-gray-600"> - CPF: ${acomp.cpf}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}

                            <!-- Botões -->
                            <div class="flex justify-end space-x-2 pt-4">
                                <button onclick="fecharModal()" 
                                        class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                                    Fechar
                                </button>
                                <button onclick="realizarCheckOut(${data.id})" 
                                        class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                                    Realizar Check-out
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                const modalContainer = document.getElementById('modalQuarto');
                modalContainer.innerHTML = modalContent;
                modalContainer.classList.remove('hidden');

            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao carregar dados da hospedagem: ' + error.message);
                fecharModal();
            }
        }

        // Função para realizar check-out
        async function realizarCheckOut(checkinId) {
            if (!confirm('Confirma a realização do check-out?')) return;

            try {
                const response = await fetch('./api/checkin.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'checkout',
                        checkin_id: checkinId
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Resposta da API:', errorText);
                    throw new Error('Erro ao realizar check-out');
                }
                
                const result = await response.json();
                if (result.success) {
                    alert('Check-out realizado com sucesso!');
                    // Recarregar a página após o check-out
                    window.location.reload();
                } else {
                    throw new Error(result.message || 'Erro ao realizar check-out');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert(error.message || 'Erro ao realizar check-out. Tente novamente.');
            }
        }

        // Modal para quarto sujo
        function mostrarModalQuartoSujo(quarto) {
            const modalContent = `
                <div class="relative top-20 mx-auto p-5 border max-w-md shadow-lg rounded-md bg-white">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">Quarto ${quarto.numero} - Aguardando Limpeza</h3>
                        <button onclick="fecharModal()" class="text-gray-600 hover:text-gray-800">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="text-center py-4">
                        <i class="fas fa-broom text-yellow-500 text-4xl mb-4"></i>
                        <p class="text-gray-600 mb-6">Este quarto está aguardando limpeza</p>
                        
                        <button onclick="liberarQuarto(${quarto.id})" 
                                class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                            Marcar como Limpo
                        </button>
                    </div>
                </div>
            `;

            const modalContainer = document.getElementById('modalQuarto');
            modalContainer.innerHTML = modalContent;
            modalContainer.classList.remove('hidden');
        }

        // Função para liberar quarto após limpeza
        async function liberarQuarto(quartoId) {
            try {
                const response = await fetch('./api/quartos.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'update_status',
                        id: quartoId,
                        status: 'disponivel'
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Resposta da API:', errorText);
                    throw new Error('Erro ao liberar quarto');
                }
                
                const result = await response.json();
                if (result.success) {
                    alert('Quarto liberado com sucesso!');
                    fecharModal();
                    await carregarQuartos();
                } else {
                    throw new Error(result.message || 'Erro ao liberar quarto');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert(error.message || 'Erro ao liberar quarto. Tente novamente.');
            }
        }

        // Função auxiliar para formatar data e hora
        function formatarDataHora(dataString) {
            const data = new Date(dataString);
            return data.toLocaleString('pt-BR');
        }

        // Carregar cadastros para select
        async function carregarCadastros() {
            try {
                const response = await fetch('./api/cadastros.php');
                if (!response.ok) throw new Error('Erro ao carregar cadastros');
                
                const cadastros = await response.json();
                const select = document.getElementById('titularSelect');
                select.innerHTML = '<option value="">Selecione um cadastro...</option>' +
                    cadastros.map(c => `<option value="${c.id}">${c.nome} - ${c.cpf}</option>`).join('');
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao carregar cadastros. Tente novamente.');
            }
        }

        // Inicializar formulário de check-in
        function inicializarFormularioCheckIn() {
            // Limpar formulário
            document.getElementById('checkInForm').reset();
            document.getElementById('infoTitular').classList.add('hidden');
            document.getElementById('listaAcompanhantes').innerHTML = '';
            acompanhantes = [];

            // Configurar data mínima para check-in e check-out
            const agora = new Date();
            const dataMinima = agora.toISOString().slice(0, 16);
            document.getElementById('dataCheckIn').min = dataMinima;
            document.getElementById('dataCheckOutPrevisto').min = dataMinima;

            // Definir data/hora atual como padrão para check-in
            document.getElementById('dataCheckIn').value = dataMinima;
            calcularValorTotal();
        }

        // Selecionar titular
        async function selecionarTitular(cadastroId) {
            if (!cadastroId) {
                document.getElementById('infoTitular').classList.add('hidden');
                return;
            }

            try {
                const response = await fetch(`./api/cadastros.php?id=${cadastroId}`);
                if (!response.ok) throw new Error('Erro ao carregar dados do cadastro');
                
                const cadastro = await response.json();
                document.getElementById('infoTitular').innerHTML = `
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="font-semibold">${cadastro.nome}</p>
                        <p class="text-sm text-gray-600">CPF: ${cadastro.cpf}</p>
                        <p class="text-sm text-gray-600">Telefone: ${cadastro.telefone}</p>
                        <p class="text-sm text-gray-600">Cidade: ${cadastro.cidade}</p>
                    </div>
                `;
                document.getElementById('infoTitular').classList.remove('hidden');
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao carregar dados do cadastro. Tente novamente.');
            }
        }

        // Função para selecionar acompanhante
        async function selecionarAcompanhante(acompanhanteId, cadastroId) {
            if (!cadastroId) {
                document.getElementById(`infoAcomp_${acompanhanteId}`).classList.add('hidden');
                return;
            }

            try {
                const response = await fetch(`./api/cadastros.php?id=${cadastroId}`);
                if (!response.ok) throw new Error('Erro ao carregar dados do cadastro');
                
                const cadastro = await response.json();
                
                // Atualizar o objeto de acompanhantes
                const index = acompanhantes.findIndex(a => a.id === acompanhanteId);
                if (index !== -1) {
                    acompanhantes[index].cadastroId = cadastroId;
                }

                // Atualizar a exibição das informações
                document.getElementById(`infoAcomp_${acompanhanteId}`).innerHTML = `
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="font-semibold">${cadastro.nome}</p>
                        <p class="text-sm text-gray-600">CPF: ${cadastro.cpf}</p>
                        <p class="text-sm text-gray-600">Telefone: ${cadastro.telefone}</p>
                        <p class="text-sm text-gray-600">Cidade: ${cadastro.cidade}</p>
                    </div>
                `;
                document.getElementById(`infoAcomp_${acompanhanteId}`).classList.remove('hidden');
                
                // Recalcular valor total
                calcularValorTotal();
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao carregar dados do cadastro. Tente novamente.');
            }
        }

        // Função para adicionar acompanhante
        function adicionarAcompanhante() {
            if (acompanhantes.length >= quartoSelecionado.capacidade - 1) {
                alert('Capacidade máxima do quarto atingida!');
                return;
            }

            const container = document.getElementById('listaAcompanhantes');
            const acompanhanteId = Date.now();

            acompanhanteDiv = document.createElement('div');
            acompanhanteDiv.innerHTML = `
                <div class="flex gap-4 items-end" id="acomp_${acompanhanteId}">
                    <div class="flex-grow">
                        <label class="block text-sm font-medium text-gray-700">Selecionar Acompanhante</label>
                        <select class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                                onchange="selecionarAcompanhante(${acompanhanteId}, this.value)">
                            <option value="">Selecione um cadastro...</option>
                            ${document.getElementById('titularSelect').innerHTML}
                        </select>
                    </div>
                    <button type="button" onclick="removerAcompanhante(${acompanhanteId})"
                            class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="infoAcomp_${acompanhanteId}" class="mt-2 hidden"></div>
            `;

            container.appendChild(acompanhanteDiv);
            acompanhantes.push({ id: acompanhanteId });
            calcularValorTotal();
        }

        // Função para remover acompanhante
        function removerAcompanhante(acompanhanteId) {
            const elemento = document.getElementById(`acomp_${acompanhanteId}`);
            if (elemento) {
                elemento.parentElement.remove();
                acompanhantes = acompanhantes.filter(a => a.id !== acompanhanteId);
                calcularValorTotal();
            }
        }

        // Função para salvar cadastro rápido
        async function salvarCadastroRapido(event, tipo) {
            event.preventDefault();

            const dados = {
                nome: document.getElementById('nomeRapido').value,
                cpf: document.getElementById('cpfRapido').value,
                telefone: document.getElementById('telefoneRapido').value,
                cidade: document.getElementById('cidadeRapido').value
            };

            try {
                const response = await fetch('./api/cadastros.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });

                if (!response.ok) throw new Error('Erro ao salvar cadastro');
                
                const result = await response.json();
                if (result.success) {
                    await carregarCadastros(); // Recarrega a lista de cadastros
                    fecharModalCadastroRapido();
                    
                    // Se for cadastro de titular, seleciona automaticamente
                    if (tipo === 'titular') {
                        document.getElementById('titularSelect').value = result.id;
                        await selecionarTitular(result.id);
                    }
                } else {
                    throw new Error(result.message || 'Erro ao salvar cadastro');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert(error.message || 'Erro ao salvar cadastro. Tente novamente.');
            }
        }

        // Função para fechar modal de cadastro rápido
        function fecharModalCadastroRapido() {
            document.getElementById('modalCadastroRapido').classList.add('hidden');
        }

        // Função para mostrar modal de check-in
        async function mostrarModalCheckIn(quarto) {
            quartoSelecionado = quarto;
            valorPorPessoa = parseFloat(quarto.preco_diaria);

            const modalContent = `
                <div class="relative top-10 mx-auto p-5 border max-w-4xl shadow-lg rounded-md bg-white">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-bold">Check-in - Quarto ${quarto.numero}</h3>
                        <button onclick="fecharModal()" class="text-gray-600 hover:text-gray-800">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Informações do Quarto -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <span class="font-semibold">Tipo:</span>
                                <span>${quarto.tipo}</span>
                            </div>
                            <div>
                                <span class="font-semibold">Capacidade:</span>
                                <span>${quarto.capacidade} pessoas</span>
                            </div>
                            <div>
                                <span class="font-semibold">Valor por pessoa:</span>
                                <span>R$ ${quarto.preco_diaria}</span>
                            </div>
                        </div>
                    </div>

                    <form id="checkInForm" onsubmit="realizarCheckIn(event)" class="space-y-6">
                        <input type="hidden" id="quartoId" value="${quarto.id}">
                        
                        <!-- Titular da Hospedagem -->
                        <div class="border-b pb-4">
                            <h4 class="text-lg font-semibold mb-4">Titular da Hospedagem</h4>
                            <div class="flex gap-4 items-end">
                                <div class="flex-grow">
                                    <label class="block text-sm font-medium text-gray-700">Selecionar Cadastro</label>
                                    <select id="titularSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                                            onchange="selecionarTitular(this.value)">
                                        <option value="">Selecione um cadastro...</option>
                                    </select>
                                </div>
                                <button type="button" onclick="abrirModalCadastroRapido('titular')"
                                        class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                                    Novo Cadastro
                                </button>
                            </div>
                            <div id="infoTitular" class="mt-4 hidden">
                                <!-- Preenchido via JavaScript -->
                            </div>
                        </div>

                        <!-- Acompanhantes -->
                        <div class="border-b pb-4">
                            <h4 class="text-lg font-semibold mb-4">Acompanhantes</h4>
                            <div id="listaAcompanhantes" class="space-y-4">
                                <!-- Lista de acompanhantes adicionados -->
                            </div>
                            <button type="button" onclick="adicionarAcompanhante()"
                                    class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                <i class="fas fa-plus mr-2"></i>Adicionar Acompanhante
                            </button>
                        </div>

                        <!-- Valores e Datas -->
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Datas</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Check-in</label>
                                        <input type="datetime-local" id="dataCheckIn" required
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Check-out Previsto</label>
                                        <input type="datetime-local" id="dataCheckOutPrevisto" required
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                                               onchange="calcularValorTotal()">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold mb-4">Valores</h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Valor Base</label>
                                        <input type="text" id="valorBase" readonly
                                               class="mt-1 block w-full rounded-md bg-gray-50 border-gray-300 shadow-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Desconto</label>
                                        <input type="number" id="desconto" min="0" step="0.01"
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                                               onchange="calcularValorTotal()">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Valor Total</label>
                                        <input type="text" id="valorTotal" readonly
                                               class="mt-1 block w-full rounded-md bg-gray-50 border-gray-300 shadow-sm font-bold text-lg">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botões -->
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="fecharModal()"
                                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                                Cancelar
                            </button>
                            <button type="submit"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                Confirmar Check-in
                            </button>
                        </div>
                    </form>
                </div>
            `;

            const modalContainer = document.getElementById('modalQuarto');
            modalContainer.innerHTML = modalContent;
            modalContainer.classList.remove('hidden');

            // Carregar cadastros para o select
            await carregarCadastros();
            
            // Inicializar formulário
            inicializarFormularioCheckIn();
        }

        // Função para calcular valor total
        function calcularValorTotal() {
            const numPessoas = 1 + acompanhantes.length; // titular + acompanhantes
            const dataCheckIn = new Date(document.getElementById('dataCheckIn').value);
            const dataCheckOut = new Date(document.getElementById('dataCheckOutPrevisto').value);
            const desconto = parseFloat(document.getElementById('desconto').value) || 0;

            // Calcular número de diárias
            const diffTime = Math.abs(dataCheckOut - dataCheckIn);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const numDiarias = diffDays || 1; // mínimo 1 diária

            // Calcular valores
            const valorBase = numPessoas * valorPorPessoa * numDiarias;
            const valorTotal = valorBase - desconto;

            // Atualizar campos
            document.getElementById('valorBase').value = `R$ ${valorBase.toFixed(2)}`;
            document.getElementById('valorTotal').value = `R$ ${valorTotal.toFixed(2)}`;
        }

        async function realizarCheckIn(event) {
            event.preventDefault();

            const valorTotalStr = document.getElementById('valorTotal').value;
            const valorTotal = parseFloat(valorTotalStr.replace('R$ ', '').replace('.', '').replace(',', '.'));
            
            const dados = {
                action: 'create',
                quarto_id: quartoSelecionado.id,
                titular_id: document.getElementById('titularSelect').value,
                acompanhantes: acompanhantes.map(a => a.cadastroId).filter(Boolean),
                data_checkin: document.getElementById('dataCheckIn').value,
                data_checkout_previsto: document.getElementById('dataCheckOutPrevisto').value,
                valor_total: valorTotal,
                desconto: parseFloat(document.getElementById('desconto').value) || 0
            };

            try {
                const response = await fetch('./api/checkin.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Resposta da API:', errorText);
                    throw new Error('Erro ao realizar check-in');
                }
                
                const result = await response.json();
                if (result.success) {
                    alert('Check-in realizado com sucesso!');
                    // Recarregar a página após o check-in
                    window.location.reload();
                } else {
                    throw new Error(result.message || 'Erro ao realizar check-in');
                }
            } catch (error) {
                console.error('Erro completo:', error);
                alert(error.message || 'Erro ao realizar check-in. Tente novamente.');
            }
        }

        // Função para fechar modal
        function fecharModal() {
            // Fecha o modal principal
            document.getElementById('modalQuarto').classList.add('hidden');
            
            // Fecha o modal de cadastro rápido se estiver aberto
            const modalCadastroRapido = document.getElementById('modalCadastroRapido');
            if (modalCadastroRapido) {
                modalCadastroRapido.classList.add('hidden');
            }
            
            // Limpa as variáveis globais
            quartoSelecionado = null;
            acompanhantes = [];
            valorPorPessoa = 0;
        }

        // Função para fechar modal de cadastro rápido especificamente
        function fecharModalCadastroRapido() {
            document.getElementById('modalCadastroRapido').classList.add('hidden');
        }

        // Adicionar listener para fechar modal ao clicar fora dele (opcional)
        document.addEventListener('click', function(event) {
            const modalQuarto = document.getElementById('modalQuarto');
            const modalCadastroRapido = document.getElementById('modalCadastroRapido');
            
            // Se clicou fora do conteúdo do modal
            if (event.target === modalQuarto) {
                fecharModal();
            }
            
            // Se clicou fora do conteúdo do modal de cadastro rápido
            if (event.target === modalCadastroRapido) {
                fecharModalCadastroRapido();
            }
        });
    </script>
</body>
</html>